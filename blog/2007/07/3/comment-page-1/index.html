<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 7) & !(IE 8)]><!-->
<html lang="en-US">
<!--<![endif]-->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<title>How to make a Bochs disk image | Julien Lecomte&#039;s Blog</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="pingback" href="http://www.julienlecomte.net/blog/xmlrpc.php" />
<!--[if lt IE 9]>
<script src="http://www.julienlecomte.net/blog/wp-content/themes/twentytwelve/js/html5.js" type="text/javascript"></script>
<![endif]-->
<link rel="alternate" type="application/rss+xml" title="Julien Lecomte&#039;s Blog &raquo; Feed" href="../../../../feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="Julien Lecomte&#039;s Blog &raquo; Comments Feed" href="../../../../comments/feed/index.html" />
<link rel="alternate" type="application/rss+xml" title="Julien Lecomte&#039;s Blog &raquo; How to make a Bochs disk image Comments Feed" href="../feed/index.html" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"http:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/www.julienlecomte.net\/blog\/wp-includes\/js\/wp-emoji-release.min.js"}};
			!function(a,b,c){function d(a){var c=b.createElement("canvas"),d=c.getContext&&c.getContext("2d");return d&&d.fillText?(d.textBaseline="top",d.font="600 32px Arial","flag"===a?(d.fillText(String.fromCharCode(55356,56812,55356,56807),0,0),c.toDataURL().length>3e3):(d.fillText(String.fromCharCode(55357,56835),0,0),0!==d.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='colorbox-theme1-css'  href='../../../../wp-content/plugins/jquery-lightbox-for-native-galleries/colorbox/theme1/colorbox.css' type='text/css' media='screen' />
<link rel='stylesheet' id='twentytwelve-fonts-css'  href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700&#038;subset=latin,latin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='twentytwelve-style-css'  href='../../../../wp-content/themes/twentytwelve/style.css' type='text/css' media='all' />
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentytwelve-ie-css'  href='http://www.julienlecomte.net/blog/wp-content/themes/twentytwelve/css/ie.css' type='text/css' media='all' />
<![endif]-->
<script type='text/javascript' src='../../../../wp-includes/js/jquery/jquery.js'></script>
<script type='text/javascript' src='../../../../wp-includes/js/jquery/jquery-migrate.min.js'></script>
<script type='text/javascript' src='../../../../wp-content/plugins/jquery-lightbox-for-native-galleries/colorbox/jquery.colorbox-min.js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../../xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../../../wp-includes/wlwmanifest.xml" /> 
<link rel='next' title='IE6, CSS Sprites and Alpha Transparency' href='../../../../index.html?p=4' />
<meta name="generator" content="WordPress 4.3" />
<link rel='canonical' href='index.html#comments' />
<link rel='shortlink' href='../../../../index.html?p=3' />
	<link href="../../../../wp-content/plugins/google-code-prettify/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="../../../../wp-content/plugins/google-code-prettify/prettify.js"></script>
	<!-- jQuery Lightbox For Native Galleries v3.2.2 | http://www.viper007bond.com/wordpress-plugins/jquery-lightbox-for-native-galleries/ -->
<script type="text/javascript">
// <![CDATA[
	jQuery(document).ready(function($){
		$(".gallery").each(function(index, obj){
			var galleryid = Math.floor(Math.random()*10000);
			$(obj).find("a").colorbox({rel:galleryid, maxWidth:"95%", maxHeight:"95%"});
		});
		$("a.lightbox").colorbox({maxWidth:"95%", maxHeight:"95%"});
	});
// ]]>
</script>
</head>

<body class="single single-post postid-3 single-format-standard full-width custom-font-enabled single-author">
<div id="page" class="hfeed site">
	<header id="masthead" class="site-header" role="banner">
		<hgroup>
			<h1 class="site-title"><a href="../../../../../index.html" title="Julien Lecomte&#039;s Blog" rel="home">Julien Lecomte&#039;s Blog</a></h1>
			<h2 class="site-description">Woodworking, Amateur Astronomy, Web Development and Operating System Programming.</h2>
		</hgroup>

		<nav id="site-navigation" class="main-navigation" role="navigation">
			<button class="menu-toggle">Menu</button>
			<a class="assistive-text" href="index.html#content" title="Skip to content">Skip to content</a>
			<div class="nav-menu"><ul><li ><a href="../../../../../index.html">Home</a></li><li class="page_item page-item-36"><a href="../../../../about-the-author/index.html">About The Author</a></li></ul></div>
		</nav><!-- #site-navigation -->

			</header><!-- #masthead -->

	<div id="main" class="wrapper">
	<div id="primary" class="site-content">
		<div id="content" role="main">

			
				
	<article id="post-3" class="post-3 post type-post status-publish format-standard hentry category-system-programming">
				<header class="entry-header">
			
						<h1 class="entry-title">How to make a Bochs disk image</h1>
								</header><!-- .entry-header -->

				<div class="entry-content">
			<p>In this article, I try to synthesize several (incomplete or inaccurate) articles I&#8217;ve found on the Internet to guide you through the process of creating a disk image you may use with the <a href="http://bochs.sourceforge.net/" target="_blank">Bochs emulator</a>. The steps described below are intended for a GNU/Linux system and some of them require super user privileges. Also, you need to have GRUB installed on your system.</p>
<p>1. Create a disk image. Here, I create a file named disk.img, containing 10080 blocks (each block being 512 bytes, this will create a file that&#8217;s about 5MB)</p>
<pre>$ dd if=/dev/zero of=disk.img count=10080</pre>
<p>2. Use FDISK to create a partition table on the image file:</p>
<pre>$ fdisk disk.img

   x     -> Extra functionality
   c 10  -> 10 cylinders
   h 16  -> 16 heads
   s 63  -> 63 sectors per track
   r     -> Return to main menu
   n     -> Create a new partition
   p     -> Primary
   1     -> Partition #1
   1     -> First cylinder
   10    -> Last cylinder
   a     -> Set bootable flag
   1     -> Partition number
   w     -> Write partition to disk</pre>
<p>Note that you have to tell fdisk about the geometry of your disk, and that geometry has to match the size of the disk you created in step 1 (10 cylinders * 16 heads * 63 sectors per track = 10080 blocks). For an introduction on disk geometry, cylinders, heads and sectors, read this <a href="http://en.wikipedia.org/wiki/Cylinder-head-sector" target="_blank">Wikipedia article</a>.</p>
<p>Let&#8217;s take a quick look at the Partition Table in the Master Boot Record (See <a href="http://en.wikipedia.org/wiki/Master_Boot_Record" target="_blank">this Wikipedia article</a> for a description of the structure of the partition table)</p>
<pre>$ hexdump disk.img</pre>
<p>The 16 bytes at offset 446 (0x1BE) are:</p>
<pre>0180 0001 0f83 093f 003f 0000 2721 0000</pre>
<p>Keep in mind that these values are stored using little-endian convention (see this <a href="http://en.wikipedia.org/wiki/Endianness" target="_blank">Wikipedia article</a> to find out more about the meaning of endianness in computer science). Also see <a href="http://thestarman.pcministry.com/asm/mbr/PartTables.htm" target="_blank">this article</a> to find out how the CHS values are computed.</p>
<table border="1">
<thead style="background:#ccc">
<tr>
<th>Offset</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>0x80 means that this partition is bootable</td>
</tr>
<tr>
<td>0x01</td>
<td>0x000101 is the CHS address of the first sector in the partition:<br />S = 0x01 = 1<br />H = 0x01 = 1<br />C = 0x00 =  0</td>
</tr>
<tr>
<td>0x04</td>
<td>0x83 is the type of the partition (Linux native here)</td>
</tr>
<tr>
<td>0x05</td>
<td>0x093f0f is the CHS address of the last sector in the partition:<br />S = 0x3F = 63<br />H = 0x0F = 15<br />C = 0x09 =  9</td>
</tr>
<tr>
<td>0x08</td>
<td>0x0000003f (63) is the logical block address of the first sector in the partition</td>
</tr>
<tr>
<td>0x0C</td>
<td>0x00002721 (10017 = 10080 &#8211; 63) is the size of the partition, in number of 512 byte blocks</td>
</tr>
</tbody>
</table>
<p>3. Setup the loopback device. In order to do this, you need to calculate the offset (in bytes) of the first sector of your single partition. Use the following command:</p>
<pre>$ fdisk -l -u disk.img

  Device Boot      Start         End      Blocks   Id  System
disk.img1   *          63       10079        5008+  83  Linux</pre>
<p>This tells us that our single partition starts at the 63rd block. Hence our offset is 63 * 512 = 32256.</p>
<p>Finally, type:</p>
<pre>$ losetup -o 32256 /dev/loop0 disk.img</pre>
<p>4. Format the disk (EXT2FS)</p>
<pre>$ mkfs.ext2 /dev/loop0</pre>
<p>5. Mount the disk:</p>
<pre>$ mount -o loop /dev/loop0 /mnt</pre>
<p>6. Now, let&#8217;s install GRUB. Start by copying the necessary GRUB files:</p>
<pre>$ mkdir -p /mnt/boot/grub
$ cp /boot/grub/stage1 /boot/grub/stage2 /mnt/boot/grub/
$ vi /mnt/boot/grub/grub.conf

   title=MyKernel
   root (hd0,0)
   kernel /mykernel</pre>
<p>7. Unmount the device:</p>
<pre>$ umount /mnt</pre>
<p>8. Detach the loopback device:</p>
<pre>$ losetup -d /dev/loop0</pre>
<p>9. Finish up the GRUB installation:</p>
<pre>$ grub --device-map=/dev/null

   device (hd0) disk.img
   geometry (hd0) 10 16 63
   root (hd0,0)
   setup (hd0)
   quit</pre>
<p>10. Setup your .bochsrc file in the same directory as your disk image:</p>
<pre style="overflow:auto;overflow-y:hidden;">megs: 32
romimage: file=/usr/local/share/bochs/BIOS-bochs-latest, address=0xf0000
vgaromimage: file=/usr/local/share/bochs/VGABIOS-elpin-2.40
ata0-master: type=disk, path="disk.img", mode=flat, cylinders=10, heads=16, spt=63
cpu: count=1, ips=15000000
mouse: enabled=0
log: out.bochs
boot: disk</pre>
<p>That&#8217;s it. Start Bochs and the GRUB interface should appear:</p>
<p><a href='../../../../../blogfiles/images/grub.png' title='Bochs emulator showing GRUB'><img src='../../../../../blogfiles/images/grub.thumbnail.png' alt='Bochs emulator showing GRUB' /></a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
			This entry was posted in <a href="../../../../category/system-programming/index.html" rel="category tag">System Programming</a> on <a href="../../../../2007/07/3/index.html" title="8:57 pm" rel="bookmark"><time class="entry-date" datetime="2007-07-23T20:57:49+00:00">July 23, 2007</time></a><span class="by-author"> by <span class="author vcard"><a class="url fn n" href="../../../../author/admin/index.html" title="View all posts by Julien Lecomte" rel="author">Julien Lecomte</a></span></span>.								</footer><!-- .entry-meta -->
	</article><!-- #post -->

				<nav class="nav-single">
					<h3 class="assistive-text">Post navigation</h3>
					<span class="nav-previous"></span>
					<span class="nav-next"><a href="../../../../2007/07/4/index.html" rel="next">IE6, CSS Sprites and Alpha Transparency <span class="meta-nav">&rarr;</span></a></span>
				</nav><!-- .nav-single -->

				
<div id="comments" class="comments-area">

	
			<h2 class="comments-title">
			3 thoughts on &ldquo;<span>How to make a Bochs disk image</span>&rdquo;		</h2>

		<ol class="commentlist">
				<li class="comment even thread-even depth-1" id="li-comment-221">
		<article id="comment-221" class="comment">
			<header class="comment-meta comment-author vcard">
				<img alt='' src='http://2.gravatar.com/avatar/2adb50a91f12b7a3a2ab01753f66c65d?s=44&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/2adb50a91f12b7a3a2ab01753f66c65d?s=88&amp;d=mm&amp;r=g 2x' class='avatar avatar-44 photo' height='44' width='44' /><cite><b class="fn">Xuedan</b> </cite><a href="index.html#comment-221"><time datetime="2007-09-14T01:09:58+00:00">September 14, 2007 at 1:09 am</time></a>			</header><!-- .comment-meta -->

			
			<section class="comment-content comment">
				<p>I follow your steps to create disk image and install grub into that file. Copy kernel on Fedora 7 into that image also. but I don&#8217;t successfully boot it under bochs. More info. is at <a href="http://www.linuxforums.org/forum/linux-kernel/102219-erro-install-grub-onto-bochs-image-file-new-post.html" rel="nofollow">http://www.linuxforums.org/forum/linux-kernel/102219-erro-install-grub-onto-bochs-image-file-new-post.html</a>. </p>
<p>Would you like to check that information?</p>
<p>Thanks</p>
							</section><!-- .comment-content -->

			<div class="reply">
							</div><!-- .reply -->
		</article><!-- #comment-## -->
	</li><!-- #comment-## -->
	<li class="comment odd alt thread-odd thread-alt depth-1" id="li-comment-3193">
		<article id="comment-3193" class="comment">
			<header class="comment-meta comment-author vcard">
				<img alt='' src='http://2.gravatar.com/avatar/80644818430195716987031d3b83508d?s=44&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/80644818430195716987031d3b83508d?s=88&amp;d=mm&amp;r=g 2x' class='avatar avatar-44 photo' height='44' width='44' /><cite><b class="fn"><a href='http://www.omninerd.com' rel='external nofollow' class='url'>markmcb</a></b> </cite><a href="index.html#comment-3193"><time datetime="2009-01-25T00:56:15+00:00">January 25, 2009 at 12:56 am</time></a>			</header><!-- .comment-meta -->

			
			<section class="comment-content comment">
				<p>Julien, great article.  Just thought I&#8217;d pass this article as it is related and focuses more on the GRUB side of things:</p>
<p><a href="http://www.omninerd.com/articles/Installing_GRUB_on_a_Hard_Disk_Image_File" rel="nofollow">http://www.omninerd.com/articles/Installing_GRUB_on_a_Hard_Disk_Image_File</a></p>
							</section><!-- .comment-content -->

			<div class="reply">
							</div><!-- .reply -->
		</article><!-- #comment-## -->
	</li><!-- #comment-## -->
	<li class="comment even thread-even depth-1" id="li-comment-3284">
		<article id="comment-3284" class="comment">
			<header class="comment-meta comment-author vcard">
				<img alt='' src='http://0.gravatar.com/avatar/cb498063df804b7e8d4fa1d3a626779e?s=44&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/cb498063df804b7e8d4fa1d3a626779e?s=88&amp;d=mm&amp;r=g 2x' class='avatar avatar-44 photo' height='44' width='44' /><cite><b class="fn">Kaustubh Ashtekar</b> </cite><a href="index.html#comment-3284"><time datetime="2009-05-02T23:26:27+00:00">May 2, 2009 at 11:26 pm</time></a>			</header><!-- .comment-meta -->

			
			<section class="comment-content comment">
				<p>Thank you Julien. Really good article. Well written.<br />
I was in need of such an article to start working with bochs. :)</p>
							</section><!-- .comment-content -->

			<div class="reply">
							</div><!-- .reply -->
		</article><!-- #comment-## -->
	</li><!-- #comment-## -->
		</ol><!-- .commentlist -->

		
				<p class="nocomments">Comments are closed.</p>
		
	
	
</div><!-- #comments .comments-area -->
			
		</div><!-- #content -->
	</div><!-- #primary -->


		<script type="text/javascript">
		window.onload = function(){prettyPrint();};
	</script>
	</div><!-- #main .wrapper -->
	<footer id="colophon" role="contentinfo">
		<div class="site-info">
						<a href="http://wordpress.org/" title="Semantic Personal Publishing Platform">Proudly powered by WordPress</a>
		</div><!-- .site-info -->
	</footer><!-- #colophon -->
</div><!-- #page -->

<script type="text/javascript">
// <![CDATA[
// ]]>
</script>
<script type='text/javascript' src='../../../../wp-content/themes/twentytwelve/js/navigation.js'></script>
</body>
</html>
